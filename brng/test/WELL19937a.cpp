#include "../../test_simple/test_simple_include.hpp"
#include "test_tools_rng.hpp"

extern "C" {
#include "external/WELL19937a.h"
}

#include "distribution/uniform_distribution.hpp"
#include <WELL19937a.hpp>

#include <chrono>
#include <cstdint>
#include <iostream>
#include <numeric>
#include <random>

auto main() -> int {
    {
        std::seed_seq seq{1, 2, 3, 4, 5};
        adhoc::canonical<adhoc::WELL19937a<std::uint32_t>> rng(seq);

        std::array<unsigned int, 624> seed = {
            495488687,  2980659413, 606040790,  1963951750, 3030748455,
            1429668922, 2917686213, 2462938687, 1013556646, 978545500,
            3983455101, 3029760161, 2226344132, 2707903695, 1543619013,
            3327817831, 473133348,  288638758,  2847857417, 3039284490,
            1644390794, 2668313047, 2090944922, 4273975554, 4259055444,
            4040156747, 2744149516, 1737452720, 3241895689, 3315423770,
            2299011897, 3825067065, 52703234,   1930674774, 3548869032,
            3414932119, 2214831201, 3833768756, 2223478235, 3227362711,
            2562160968, 3117769472, 139427487,  2844581692, 1009604280,
            2600832476, 3424130573, 2511703315, 4218422678, 1932705526,
            1079099570, 2944210626, 3707266228, 617901551,  4095814318,
            3172666512, 1286943843, 2494543352, 3481336409, 3214195908,
            1436473199, 2468667127, 10480115,   3599026277, 1777921078,
            599905610,  2869482742, 2701635817, 2086068660, 847422091,
            100432375,  979800386,  881237335,  3745521067, 883913299,
            867551080,  3365158687, 2052500332, 785726113,  4121505792,
            180751857,  2732854096, 4183062429, 269116305,  495888090,
            2016836112, 2855027264, 1196032983, 830769361,  4232676940,
            3012507723, 3358369638, 2142775612, 801664134,  726965375,
            2619112436, 3227412493, 689831707,  3960691867, 4254687458,
            2233947386, 1955373110, 2332766926, 1411569622, 1247651322,
            4015532401, 154643292,  3466101657, 1382974942, 3526574877,
            730272996,  2869313122, 129023854,  114319368,  3774367359,
            3535025888, 1253799867, 557409271,  253160836,  1288941084,
            1513644405, 1445724981, 3946656009, 83658300,   2042275615,
            3684187350, 703230134,  190135194,  4179397150, 2658389417,
            393500558,  4235520162, 2186415091, 1804437907, 3415146644,
            815999553,  1475263384, 3096765992, 91844137,   2729216858,
            4141238742, 661855107,  3101554141, 2397147590, 392489813,
            3613644887, 4004384561, 4254365986, 2056787810, 2825857072,
            1257528107, 361781166,  639913192,  2981991224, 4179690397,
            3804104215, 3711238020, 3259744811, 2832998480, 373002730,
            2755400818, 3644526791, 3244927866, 3390515920, 1101002433,
            2741884477, 4235242767, 731569058,  1016194199, 2607299945,
            2077685100, 2459014934, 1688560319, 4250586211, 1888591547,
            849980838,  2867045695, 1903350785, 2851726899, 317850264,
            3429529901, 3260302795, 3602210285, 731306783,  2200291981,
            2034347154, 4125529990, 990386081,  1262394815, 3903172050,
            2011776694, 1861476500, 71808934,   2721131186, 4201343685,
            765571054,  2096644670, 2563151187, 3950766849, 152049663,
            1102445500, 3299041791, 2214019356, 1763805822, 1521065988,
            2287797652, 1639535815, 2881149940, 3659595380, 4220766823,
            906691328,  3866518603, 2396444307, 2029528332, 1387469754,
            2744136891, 2629909274, 4183170912, 1609024453, 3999731467,
            2344084664, 2084654096, 839803373,  1408224191, 3408935004,
            1145842953, 3768387200, 1228484703, 2794334725, 2835878080,
            4137140120, 2199700501, 2056679407, 4071548706, 2489011379,
            33705541,   4107013337, 1032416762, 1226818106, 1829780758,
            2887634405, 4280013982, 2276573082, 3591408742, 2452638347,
            1989417197, 3579875030, 2911994681, 3937637608, 2721302665,
            1261926223, 1534312804, 562262287,  3207664939, 713169731,
            12678977,   3668637328, 2644550739, 636941655,  797303332,
            1784441044, 3463299087, 2766468587, 1967252212, 3066894931,
            3384645483, 1070624118, 2805693268, 3598092348, 2559718624,
            3363109795, 225913077,  1724133736, 2834407095, 1246349282,
            366906164,  3432329748, 1114153237, 1408516245, 1317329577,
            1407067277, 1584664014, 2227499484, 2098516034, 2906305681,
            1187272603, 3918518129, 3844962031, 892197686,  1424877302,
            472303226,  419506633,  753347492,  2396606553, 1537190596,
            2688241851, 1365610490, 4051229766, 1524210049, 4272643597,
            603186242,  2892757292, 649619449,  2598584816, 3424360210,
            3103355422, 3442168676, 352314940,  792405755,  201823710,
            656239718,  125143519,  171534686,  266661902,  926598446,
            2951441978, 1933896096, 1079365757, 2904435506, 3283486545,
            2677270702, 1625304034, 1359100598, 978829556,  3634131427,
            127364427,  4213645305, 3844208993, 197464289,  3602666594,
            1748955235, 4195494565, 2293797161, 3817695407, 842941844,
            1143614990, 4004908371, 2248762316, 1455075429, 1459541559,
            3438204412, 769463503,  4027234977, 813807639,  548740532,
            4287733870, 964501422,  2076444626, 1273276958, 2633676375,
            2554950224, 66235694,   1359220480, 2329833399, 1618383554,
            1231542078, 2640643680, 3309691577, 569261107,  2423472749,
            2305311987, 3484577127, 3923494923, 527606367,  2670319399,
            1348171251, 1186818929, 3725395684, 956492740,  4010265864,
            2441183803, 3604458883, 3317415032, 113614651,  2873093397,
            4146018091, 2145241706, 1611113410, 792710925,  296034780,
            4237861141, 3084968519, 1281233470, 3079687096, 1674341208,
            1411384581, 4015613888, 2238662851, 1380839764, 2218927983,
            1853445811, 3117449955, 1038512195, 444554553,  2876563754,
            1918750224, 1244470002, 1059036747, 356361635,  1207954340,
            2778505423, 837385329,  2200977192, 3837978630, 2044827902,
            2004335205, 4003944469, 3400822734, 3300088044, 2308013418,
            2857062741, 1689082141, 658358294,  3837885353, 32988299,
            3490723393, 4100889857, 922507699,  996308902,  928973802,
            2383984249, 96917418,   2821659026, 3010960595, 599344833,
            4184262190, 2737039017, 7226976,    1127415237, 695856330,
            2277200148, 2581326175, 556010240,  1475016307, 1724091931,
            4281744979, 588480437,  1634021018, 4099807256, 3726278240,
            2320294344, 1210056523, 4156158453, 1668393795, 2838537699,
            1150257294, 2793983877, 539273869,  1625153801, 754017343,
            3715811497, 1749317302, 1851285851, 3373411474, 1220477954,
            1570755757, 1093539285, 712458126,  2145511870, 3944148670,
            1471151765, 3726397240, 1019305661, 3054234469, 1737327842,
            1923387002, 3948911137, 3492113255, 2490742708, 357827156,
            98112890,   301061996,  2718685514, 4187181013, 2151592242,
            32869783,   3846728039, 2954807027, 1397768984, 1991601152,
            3363073696, 3293758910, 591460402,  978197664,  2678130775,
            669135140,  4153584435, 4057158333, 1175023778, 1587317339,
            2495232288, 2611289125, 1694010547, 2677580712, 217886461,
            4253915501, 370390415,  2817577964, 309029376,  3832957968,
            2002090714, 3052397371, 3684208937, 4228772870, 2756499332,
            3350295997, 313208773,  2022885338, 134273347,  469103890,
            1294557927, 4102692370, 1999527855, 2785450817, 677692000,
            1065402620, 1069104971, 3594563953, 1237704622, 1384351782,
            2252119550, 2518345075, 3836264150, 4195090198, 2205164736,
            200416668,  609192679,  2678370310, 519087151,  351331566,
            1924018907, 827006493,  3900162585, 1146968592, 4136135037,
            2429083866, 3794966735, 941995576,  3054516215, 2554732838,
            184344870,  3992434031, 2895329756, 3641673460, 3853553855,
            1421904235, 2538113572, 2227110922, 4265197197, 3566510780,
            484330432,  3784123427, 26679122,   2326005426, 3587124558,
            4080795311, 3765069774, 2948034362, 2590273144, 3390684015,
            2236825728, 3911700895, 1089107392, 1649034395, 4090248223,
            3294323824, 2784766545, 952493083,  266919819,  904205128,
            2462083743, 1085907354, 2436046923, 2662158024, 2778954015,
            1401812451, 1663643343, 1853688334, 4094118726, 4092498286,
            4224278188, 3815856935, 4155797484, 2227866499, 1305566399,
            4027271291, 3412739373, 1125917387, 2766443908, 2335690314,
            2855452033, 3943533664, 1782167305, 3337055458, 4138719377,
            2102084484, 4118647205, 1211201490, 1391477118, 1524769787,
            3902391203, 3328902935, 3833443107, 3229470487, 4014388712,
            977715634,  2216044831, 2249170693, 765601675,  2665102121,
            2607161695, 4230152682, 217978075,  2982386590, 386407855,
            1784432351, 393538233,  332727357,  3814465261, 55724052,
            772028817,  247244410,  276497511,  3021644578};
        InitWELLRNG19937a(seed.data());

        std::cout.precision(std::numeric_limits<double>::max_digits10);
        for (std::size_t i = 0; i < 1000000; ++i) {
            auto val1 = rng();
            auto val2 = WELLRNG19937a();
            EXPECT_EQUAL(val1, val2);
            if (val1 != val2) {
                std::cout << val1 << std::endl;
                std::cout << val2 << std::endl;
            }
        }
    }

    {
        std::seed_seq seq{1, 2, 3, 4, 5};
        adhoc::WELL19937a<std::uint32_t> rng(seq);
        check_fwd_and_back(rng, 1000000);
        adhoc::WELL19937a<std::uint32_t> rng2(seq);
        EXPECT_EQUAL(rng, rng2);
    }

    {
        std::seed_seq seq{1, 2, 3, 4, 5};
        adhoc::WELL19937a<std::uint32_t> rng(seq);
        check_back_and_fwd(rng, 1000000);
        adhoc::WELL19937a<std::uint32_t> rng2(seq);
        EXPECT_EQUAL(rng, rng2);
    }

    int sims = 0;
    if (auto env_p = std::getenv("TIMING_SIMS")) {
        sims = std::atoi(env_p);
    }

    if (sims) {
        double res1 = 0;
        std::seed_seq seq{1, 2, 3, 4, 5};
        adhoc::canonical<adhoc::WELL19937a<std::uint_fast32_t>> rng(seq);
        {
            auto time1 = std::chrono::high_resolution_clock::now();
            for (std::size_t i = 0; i < sims; i++) {
                res1 += rng();
            }
            auto time2 = std::chrono::high_resolution_clock::now();
            auto time = std::chrono::duration_cast<std::chrono::milliseconds>(
                            time2 - time1)
                            .count();
            std::cout << "new" << std::endl;
            std::cout << time << std::endl;
        }

        double res2 = 0;
        std::array<unsigned int, 624> seed = {
            495488687,  2980659413, 606040790,  1963951750, 3030748455,
            1429668922, 2917686213, 2462938687, 1013556646, 978545500,
            3983455101, 3029760161, 2226344132, 2707903695, 1543619013,
            3327817831, 473133348,  288638758,  2847857417, 3039284490,
            1644390794, 2668313047, 2090944922, 4273975554, 4259055444,
            4040156747, 2744149516, 1737452720, 3241895689, 3315423770,
            2299011897, 3825067065, 52703234,   1930674774, 3548869032,
            3414932119, 2214831201, 3833768756, 2223478235, 3227362711,
            2562160968, 3117769472, 139427487,  2844581692, 1009604280,
            2600832476, 3424130573, 2511703315, 4218422678, 1932705526,
            1079099570, 2944210626, 3707266228, 617901551,  4095814318,
            3172666512, 1286943843, 2494543352, 3481336409, 3214195908,
            1436473199, 2468667127, 10480115,   3599026277, 1777921078,
            599905610,  2869482742, 2701635817, 2086068660, 847422091,
            100432375,  979800386,  881237335,  3745521067, 883913299,
            867551080,  3365158687, 2052500332, 785726113,  4121505792,
            180751857,  2732854096, 4183062429, 269116305,  495888090,
            2016836112, 2855027264, 1196032983, 830769361,  4232676940,
            3012507723, 3358369638, 2142775612, 801664134,  726965375,
            2619112436, 3227412493, 689831707,  3960691867, 4254687458,
            2233947386, 1955373110, 2332766926, 1411569622, 1247651322,
            4015532401, 154643292,  3466101657, 1382974942, 3526574877,
            730272996,  2869313122, 129023854,  114319368,  3774367359,
            3535025888, 1253799867, 557409271,  253160836,  1288941084,
            1513644405, 1445724981, 3946656009, 83658300,   2042275615,
            3684187350, 703230134,  190135194,  4179397150, 2658389417,
            393500558,  4235520162, 2186415091, 1804437907, 3415146644,
            815999553,  1475263384, 3096765992, 91844137,   2729216858,
            4141238742, 661855107,  3101554141, 2397147590, 392489813,
            3613644887, 4004384561, 4254365986, 2056787810, 2825857072,
            1257528107, 361781166,  639913192,  2981991224, 4179690397,
            3804104215, 3711238020, 3259744811, 2832998480, 373002730,
            2755400818, 3644526791, 3244927866, 3390515920, 1101002433,
            2741884477, 4235242767, 731569058,  1016194199, 2607299945,
            2077685100, 2459014934, 1688560319, 4250586211, 1888591547,
            849980838,  2867045695, 1903350785, 2851726899, 317850264,
            3429529901, 3260302795, 3602210285, 731306783,  2200291981,
            2034347154, 4125529990, 990386081,  1262394815, 3903172050,
            2011776694, 1861476500, 71808934,   2721131186, 4201343685,
            765571054,  2096644670, 2563151187, 3950766849, 152049663,
            1102445500, 3299041791, 2214019356, 1763805822, 1521065988,
            2287797652, 1639535815, 2881149940, 3659595380, 4220766823,
            906691328,  3866518603, 2396444307, 2029528332, 1387469754,
            2744136891, 2629909274, 4183170912, 1609024453, 3999731467,
            2344084664, 2084654096, 839803373,  1408224191, 3408935004,
            1145842953, 3768387200, 1228484703, 2794334725, 2835878080,
            4137140120, 2199700501, 2056679407, 4071548706, 2489011379,
            33705541,   4107013337, 1032416762, 1226818106, 1829780758,
            2887634405, 4280013982, 2276573082, 3591408742, 2452638347,
            1989417197, 3579875030, 2911994681, 3937637608, 2721302665,
            1261926223, 1534312804, 562262287,  3207664939, 713169731,
            12678977,   3668637328, 2644550739, 636941655,  797303332,
            1784441044, 3463299087, 2766468587, 1967252212, 3066894931,
            3384645483, 1070624118, 2805693268, 3598092348, 2559718624,
            3363109795, 225913077,  1724133736, 2834407095, 1246349282,
            366906164,  3432329748, 1114153237, 1408516245, 1317329577,
            1407067277, 1584664014, 2227499484, 2098516034, 2906305681,
            1187272603, 3918518129, 3844962031, 892197686,  1424877302,
            472303226,  419506633,  753347492,  2396606553, 1537190596,
            2688241851, 1365610490, 4051229766, 1524210049, 4272643597,
            603186242,  2892757292, 649619449,  2598584816, 3424360210,
            3103355422, 3442168676, 352314940,  792405755,  201823710,
            656239718,  125143519,  171534686,  266661902,  926598446,
            2951441978, 1933896096, 1079365757, 2904435506, 3283486545,
            2677270702, 1625304034, 1359100598, 978829556,  3634131427,
            127364427,  4213645305, 3844208993, 197464289,  3602666594,
            1748955235, 4195494565, 2293797161, 3817695407, 842941844,
            1143614990, 4004908371, 2248762316, 1455075429, 1459541559,
            3438204412, 769463503,  4027234977, 813807639,  548740532,
            4287733870, 964501422,  2076444626, 1273276958, 2633676375,
            2554950224, 66235694,   1359220480, 2329833399, 1618383554,
            1231542078, 2640643680, 3309691577, 569261107,  2423472749,
            2305311987, 3484577127, 3923494923, 527606367,  2670319399,
            1348171251, 1186818929, 3725395684, 956492740,  4010265864,
            2441183803, 3604458883, 3317415032, 113614651,  2873093397,
            4146018091, 2145241706, 1611113410, 792710925,  296034780,
            4237861141, 3084968519, 1281233470, 3079687096, 1674341208,
            1411384581, 4015613888, 2238662851, 1380839764, 2218927983,
            1853445811, 3117449955, 1038512195, 444554553,  2876563754,
            1918750224, 1244470002, 1059036747, 356361635,  1207954340,
            2778505423, 837385329,  2200977192, 3837978630, 2044827902,
            2004335205, 4003944469, 3400822734, 3300088044, 2308013418,
            2857062741, 1689082141, 658358294,  3837885353, 32988299,
            3490723393, 4100889857, 922507699,  996308902,  928973802,
            2383984249, 96917418,   2821659026, 3010960595, 599344833,
            4184262190, 2737039017, 7226976,    1127415237, 695856330,
            2277200148, 2581326175, 556010240,  1475016307, 1724091931,
            4281744979, 588480437,  1634021018, 4099807256, 3726278240,
            2320294344, 1210056523, 4156158453, 1668393795, 2838537699,
            1150257294, 2793983877, 539273869,  1625153801, 754017343,
            3715811497, 1749317302, 1851285851, 3373411474, 1220477954,
            1570755757, 1093539285, 712458126,  2145511870, 3944148670,
            1471151765, 3726397240, 1019305661, 3054234469, 1737327842,
            1923387002, 3948911137, 3492113255, 2490742708, 357827156,
            98112890,   301061996,  2718685514, 4187181013, 2151592242,
            32869783,   3846728039, 2954807027, 1397768984, 1991601152,
            3363073696, 3293758910, 591460402,  978197664,  2678130775,
            669135140,  4153584435, 4057158333, 1175023778, 1587317339,
            2495232288, 2611289125, 1694010547, 2677580712, 217886461,
            4253915501, 370390415,  2817577964, 309029376,  3832957968,
            2002090714, 3052397371, 3684208937, 4228772870, 2756499332,
            3350295997, 313208773,  2022885338, 134273347,  469103890,
            1294557927, 4102692370, 1999527855, 2785450817, 677692000,
            1065402620, 1069104971, 3594563953, 1237704622, 1384351782,
            2252119550, 2518345075, 3836264150, 4195090198, 2205164736,
            200416668,  609192679,  2678370310, 519087151,  351331566,
            1924018907, 827006493,  3900162585, 1146968592, 4136135037,
            2429083866, 3794966735, 941995576,  3054516215, 2554732838,
            184344870,  3992434031, 2895329756, 3641673460, 3853553855,
            1421904235, 2538113572, 2227110922, 4265197197, 3566510780,
            484330432,  3784123427, 26679122,   2326005426, 3587124558,
            4080795311, 3765069774, 2948034362, 2590273144, 3390684015,
            2236825728, 3911700895, 1089107392, 1649034395, 4090248223,
            3294323824, 2784766545, 952493083,  266919819,  904205128,
            2462083743, 1085907354, 2436046923, 2662158024, 2778954015,
            1401812451, 1663643343, 1853688334, 4094118726, 4092498286,
            4224278188, 3815856935, 4155797484, 2227866499, 1305566399,
            4027271291, 3412739373, 1125917387, 2766443908, 2335690314,
            2855452033, 3943533664, 1782167305, 3337055458, 4138719377,
            2102084484, 4118647205, 1211201490, 1391477118, 1524769787,
            3902391203, 3328902935, 3833443107, 3229470487, 4014388712,
            977715634,  2216044831, 2249170693, 765601675,  2665102121,
            2607161695, 4230152682, 217978075,  2982386590, 386407855,
            1784432351, 393538233,  332727357,  3814465261, 55724052,
            772028817,  247244410,  276497511,  3021644578};
        InitWELLRNG19937a(seed.data());
        {
            auto time1 = std::chrono::high_resolution_clock::now();
            for (std::size_t i = 0; i < sims; i++) {
                res2 += WELLRNG19937a();
            }
            auto time2 = std::chrono::high_resolution_clock::now();
            auto time = std::chrono::duration_cast<std::chrono::milliseconds>(
                            time2 - time1)
                            .count();
            std::cout << "old" << std::endl;
            std::cout << time << std::endl;
        }
        EXPECT_EQUAL(res1, res2);

        double res1b = 0;
        {
            auto time1 = std::chrono::high_resolution_clock::now();
            for (std::size_t i = 0; i < sims; i++) {
                res1b += rng.operator()<false>();
            }
            auto time2 = std::chrono::high_resolution_clock::now();
            auto time = std::chrono::duration_cast<std::chrono::milliseconds>(
                            time2 - time1)
                            .count();
            std::cout << "new back" << std::endl;
            std::cout << time << std::endl;
        }
        EXPECT_NEAR_REL(res1, res1b, 1e-5);
    }

    TEST_END;
}
